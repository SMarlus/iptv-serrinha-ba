name: Atualizar playlist IPTV Serrinha-BA

on:
  schedule:
    - cron: '0 */6 * * *' # Roda a cada 6 horas
  workflow_dispatch: # Permite rodar manualmente

permissions:
  contents: write # Garante permissão para salvar o arquivo

jobs:
  atualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Baixar repositório
        uses: actions/checkout@v3

      - name: Baixar canais da Bahia (iptv-org)
        run: |
          curl -sL https://iptv-org.github.io/iptv/subdivisions/br-ba.m3u -o br-ba.m3u

      - name: Gerar playlist final
        run: | # CORREÇÃO: Indentação alinhada corretamente
          # Criar cabeçalho
          echo "#EXTM3U" > playlist_serrinha_ba.m3u
          echo "#EXTINF:-1 logo=\"https://i.imgur.com/AAAAAA.png\", ATUALIZADO EM $(date '+%d/%m/%Y %H:%M')" >> playlist_serrinha_ba.m3u
          echo "http://fake.url/info.mp4" >> playlist_serrinha_ba.m3u
          echo "" >> playlist_serrinha_ba.m3u

          echo "# ===== Canais Abertos Nacionais =====" >> playlist_serrinha_ba.m3u

          # Baixar fontes adicionais
          curl -sL https://raw.githubusercontent.com/PaulinhoProjects/IPTV-BR/main/Paulo.m3u -o fonte1.m3u
          curl -sL https://gist.githubusercontent.com/oLucasZ7/3f0c1e0c9098a1fdb9d80fbb9f39de2e/raw -o fonte2.m3u

          # Unificar fontes
          cat fonte1.m3u fonte2.m3u > fontes_unificadas.m3u

          # CORREÇÃO DE LÓGICA:
          # Usamos grep -A 1 para pegar a linha do nome E a linha seguinte (o link)
          # --no-group-separator evita que o grep coloque "--" entre os resultados
          grep -i -A 1 --no-group-separator -E 'Globo|SBT|Record|Band|Cultura|RedeTV|Aparecida' fontes_unificadas.m3u > filtrados.m3u

          # Padronizar group-title para "Abertos BR"
          sed -i 's/group-title="[^"]*"/group-title="Abertos BR"/g' filtrados.m3u

          # Jogar para a playlist final
          cat filtrados.m3u >> playlist_serrinha_ba.m3u

          echo "" >> playlist_serrinha_ba.m3u
          echo "# ===== Canais da Bahia =====" >> playlist_serrinha_ba.m3u

          # Canais da Bahia (iptv-org)
          # Filtra cabeçalhos repetidos e muda o grupo
          grep -v '^#EXTM3U' br-ba.m3u | sed 's/group-title="[^"]*"/group-title="Bahia"/' >> playlist_serrinha_ba.m3u

      - name: Commit automático
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add playlist_serrinha_ba.m3u
          # O commit só acontece se houver mudança
          git commit -m "Atualização automática: $(date '+%d/%m/%Y %H:%M')" || echo "Sem mudanças para commitar"
          git push